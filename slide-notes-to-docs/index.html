<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Slide Notes to Docs</title>
</head>
<body>
  <h1>Slide Notes to Docs</h1>
  <button>Select Google Slides presentation</button>

  <script>
    const CLIENT_ID = '1092965391608-sm6vlhl55jnpi1v7hi86aqu784mlli94.apps.googleusercontent.com';

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = ({ message} ) => reject(new Error('message'));
        script.async  = true;
        script.defer = true;
        document.querySelector('body').append(script);
      });
    }

    const gapiReady = (async function() {
      await loadScript('https://apis.google.com/js/api.js');
      await new Promise((resolve, reject) => {
        gapi.load('client:picker', { callback: resolve, onerror: reject });
      });
      await gapi.client.init({});
      await Promise.all([
          gapi.client.load('docs', 'v1'),
          gapi.client.load('slides', 'v1')
        ]);
      return gapi;
    })();

    const gisReady = (async function() {
      await loadScript('https://accounts.google.com/gsi/client');
      const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.file',
          prompt: 'consent',
          callback: '',  // defined at request time in await/promise scope.
      });
      return async function(err) {
        if (true) {
        // if (err.result.error.code == 401 || (err.result.error.code == 403) &&
        //     err.result.error.status == "PERMISSION_DENIED") {
          // The access token is missing, invalid, or expired, prompt for user consent to obtain one.
          await new Promise((resolve, reject) => {
            try {
              // Settle this promise in the response callback for requestAccessToken()
              tokenClient.callback = (resp) => {
                if (resp.error !== undefined) {
                  reject(resp);
                }
                // GIS has automatically updated gapi.client with the newly issued access token.
                console.log('gapi.client access token: ' + JSON.stringify(gapi.client.getToken()));
                resolve(resp);
              };
              tokenClient.requestAccessToken();
            } catch (err) {
              console.log(err)
            }
          });
        } else {
          // Errors unrelated to authorization: server errors, exceeding quota, bad requests, and so on.
          throw new Error(err);
        }
      };
    })();

    (async function() {
      await gapiReady;
      console.log('GAPI ready');
      const getToken = await gisReady;
      console.log('GIS ready');
      getToken();
    })();
  </script>
</body>
</html>