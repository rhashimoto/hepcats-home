<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Slide Notes to Docs</title>
</head>
<body>
  <h1>Slide Notes to Docs</h1>
  <button id="select_button" disabled>Select Google Slides presentation</button>

  <div id="g_id_onload"
    data-client_id="1092965391608-sm6vlhl55jnpi1v7hi86aqu784mlli94.apps.googleusercontent.com"
    data-auto_select="true"
    data-cancel_on_tap_outside="false"
    data-callback="onSignIn"
  </div>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    const APP_ID = '1092965391608';
    const API_KEY = 'AIzaSyDbD23Z5G4n0R7BRZIQpHPG0WNU_JzC_2w';
    const CLIENT_ID = document.getElementById('g_id_onload').getAttribute('data-client_id');
    const SCOPES = ['https://www.googleapis.com/auth/drive.file'];

    const button = document.getElementById('select_button');

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = ({ message} ) => reject(new Error('message'));
        script.async  = true;
        script.defer = true;
        document.querySelector('body').append(script);
      });
    }

    const gapiReady = (async function() {
      await loadScript('https://apis.google.com/js/api.js');
      await new Promise((resolve, reject) => {
        gapi.load('client:picker', { callback: resolve, onerror: reject });
      });
      await gapi.client.init({});
      await Promise.all([
          gapi.client.load('drive', 'v3'),
          gapi.client.load('docs', 'v1'),
          gapi.client.load('slides', 'v1')
        ]);
      return gapi;
    })();

    async function onSignIn(token) {
      console.log('onSignIn', token);
      await gapiReady;
      const accessToken = await new Promise(function(resolve, reject) {
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES.join(' '),
          prompt: '',
          callback: resolve
        });
        tokenClient.requestAccessToken();
      });
      console.log('accessToken', accessToken)
      button.disabled = false;
    }

    button.addEventListener('click', createPicker);
    async function createPicker() {
      button.disabled = true;
      const pickerBuilder = new gapi.picker.api.PickerBuilder();
      const picker = pickerBuilder
        .setAppId(APP_ID)
        .setDeveloperKey(API_KEY)
        .setOAuthToken(gapi.auth.getToken().access_token)
        .addView(google.picker.ViewId.PRESENTATIONS)
        .setCallback(data => {
          button.disabled = false;
          if (data.action === 'picked') {
            handlePickedDocuments(data.docs);
          }
        })
        .build();
      picker.setVisible(true);
    }

    async function handlePickedDocuments(documents) {
      for (const document of documents) {
        try {
          console.log(document);
          const presentation = await gapi.client.slides.presentations.get({
            presentationId: document.id
          }).then(response => response.result);
          console.log(presentation);

          const notes = presentation.slides.map((slide, index) => {
            const notesPage = slide.slideProperties?.notesPage;
            const textElements = notesPage.pageElements
              .map(pageElement => pageElement.shape?.text?.textElements ?? [])
              .flat();
            const text = textElements
              .map(textElement => textElement?.textRun?.content ?? '')
              .join('');
            console.log(`slide ${index}`, text, textElements);
            return text;
          });

          // const notesDoc = await gapi.client.documents.create({
          //   title: `Notes for ${presentation.title}`
          // }).then(response => response.result);

        } catch (e) {
          console.error('', e);
        }
      }
    }
  </script>


</body>
</html>